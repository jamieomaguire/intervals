<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas-based Timer</title>
</head>

<body>
  <fieldset>
    <label for="duration">Duration (seconds)</label>
    <input type="number" name="duration" id="duration">
  </fieldset>
  <canvas id="timerCanvas"></canvas>
  <button onclick="startTimer()">Start</button>
  <button onclick="stopTimer()">Stop</button>

  <script>
    let startTime;
    let elapsed;
    let timerStopped = true;
    let duration = 0;
    
    const canvas = document.getElementById('timerCanvas');
    canvas.style.border = '1px dashed purple'
    const ctx = canvas.getContext('2d');

    window.devicePixelRatio = 2;
    const size = 250;

    canvas.style.width = size + "px";
    canvas.style.height = size + "px";

    const scale = window.devicePixelRatio;
    canvas.width = size * scale;
    canvas.height = size * scale;

    ctx.scale(scale, scale);
    ctx.font = '30px Arial';
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'left'; // default to left

    const x = size / 2;
    const y = size / 2;

    function drawTime(time) {
      console.log(time)
      ctx.clearRect(0, 0, canvas.width, canvas.height);  // Clear the canvas

      const minutes = Math.floor(time / 60000);
      const seconds = Math.floor((time % 60000) / 1000);
      const milliseconds = time % 1000;

      const minutesText = `${minutes}:`;
      const secondsText = `${seconds.toString().padStart(2, '0')}.`;
      const milliText = milliseconds.toString().slice(0, 2);

      const minutesMetrics = ctx.measureText(minutesText);
      const secondsMetrics = ctx.measureText(secondsText);

      // Draw minutes
      ctx.fillText(minutesText, x - minutesMetrics.width - secondsMetrics.width, y);

      // Draw seconds
      ctx.fillText(secondsText, x - secondsMetrics.width, y);

      // Draw milliseconds
      ctx.fillText(milliText, x, y);
    }

    // currentTime is a timestamp provided by requestAnimationFrame
    function animate(currentTime) {
      if (!startTime) {
        startTime = currentTime;
      }

      elapsed = currentTime - startTime;

      // Calculate remaining time in milliseconds
      let remainingTime = duration - elapsed;

      if (remainingTime <= 0) {
        remainingTime = 0;
        timerStopped = true;
      }

      drawTime(remainingTime);

      if (!timerStopped) {
        requestAnimationFrame(animate);
      } else {
        // Handle timer end logic here, if needed
        console.log('timer stopped')
        drawTime(0);
      }
    }

    function startTimer() {
      if (timerStopped) {
        console.log('timer started');
        duration = getDuration();
        console.log(duration)
        
        startTime = null;
        timerStopped = false;
        requestAnimationFrame(animate);
      }
    }

    function stopTimer() {
      timerStopped = true;
    }

    function getDuration () {
      return document.getElementById('duration').value * 1000;
    }
  </script>
</body>

</html>