<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <title>Custom Interval Timer</title>
</head>

<body>
  <h1>Custom Interval Timer</h1>

  <form id="timerConfigForm" onsubmit="event.preventDefault();">
    <label>Timer name:</label>
    <input type="text" id="timerName">
    <br>

    <label>Number of Rounds:</label>
    <input type="number" id="numRounds" min="1" value="1">
    <br>

    <label>Countdown Before Start (seconds):</label>
    <input type="number" id="countdownTime" value="5">
    <br>

    <div id="intervals">
      <div class="interval">
        <input type="text" placeholder="Interval Name" class="interval-name">
        <input type="number" placeholder="Interval (seconds)" class="interval-time">
        <input type="color" class="interval-color" value="#FFFFFF">
      </div>
    </div>

    <button type="button" onclick="addInterval()">Add Interval</button>
    <button type="button" onclick="startTimer()">Start</button>
    <button type="button" onclick="stopTimer()">Stop</button>
    <button type="button" onclick="saveTimerToURL()">Save Timer</button>
    <button type="button" onclick="resetTimer()">Delete Timer</button>
  </form>

  <div id="currentInterval"></div>

  <button id="installButton" style="display: none;">Install App</button>

  <script>
    function resetTimer() {
      // Reset the input fields to default values
      document.getElementById('numRounds').value = 1;
      document.getElementById('countdownTime').value = 5;
      document.getElementById('timerName').value = '';

      const intervalsContainer = document.getElementById('intervals');
      while (intervalsContainer.firstChild) {
        intervalsContainer.removeChild(intervalsContainer.lastChild);
      }
      addIntervalElement();  // Add a default interval

      // Reset the URL to the original without any parameters
      const baseURL = `${window.location.origin}${window.location.pathname}`;
      history.pushState({}, null, baseURL);
    }


    function addIntervalElement(name = '', time = '', color = '#FFFFFF') {
      const intervalDiv = document.createElement('div');
      intervalDiv.className = 'interval';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Interval Name';
      nameInput.className = 'interval-name';
      nameInput.value = name;

      const timeInput = document.createElement('input');
      timeInput.type = 'number';
      timeInput.placeholder = 'Interval (seconds)';
      timeInput.className = 'interval-time';
      timeInput.value = time;

      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.className = 'interval-color';
      colorInput.value = color;

      intervalDiv.appendChild(nameInput);
      intervalDiv.appendChild(timeInput);
      intervalDiv.appendChild(colorInput);

      document.getElementById('intervals').appendChild(intervalDiv);
    }


    function loadTimerFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      document.getElementById('timerName').value = decodeURIComponent(urlParams.get('timerName') || 'Unnamed Timer');
      document.getElementById('numRounds').value = urlParams.get('nR') || 1;
      document.getElementById('countdownTime').value = urlParams.get('cT') || 5;

      // Clear existing intervals
      const intervalsContainer = document.getElementById('intervals');
      while (intervalsContainer.firstChild) {
        intervalsContainer.removeChild(intervalsContainer.lastChild);
      }

      // Extract intervals from URL and create them dynamically
      let index = 0;
      while (urlParams.has(`iN${index}`)) {
        const intervalName = decodeURIComponent(urlParams.get(`iN${index}`));
        const intervalTime = urlParams.get(`iT${index}`);
        const intervalColor = urlParams.get(`iC${index}`);

        addIntervalElement(intervalName, intervalTime, intervalColor);
        index++;
      }

      // If no intervals were loaded from the URL, add one default interval
      if (index === 0) {
        addIntervalElement();
      }
    }

    function saveTimerToURL() {
      const timerName = encodeURIComponent(document.getElementById('timerName').value || 'Unnamed Timer');
      const nR = document.getElementById('numRounds').value;
      const cT = document.getElementById('countdownTime').value;
      const intervals = document.querySelectorAll('.interval');
      let intervalParams = '';

      intervals.forEach((interval, index) => {
        const iN = encodeURIComponent(interval.querySelector('.interval-name').value);
        const iT = encodeURIComponent(interval.querySelector('.interval-time').value);
        const iC = encodeURIComponent(interval.querySelector('.interval-color').value);

        intervalParams += `&iN${index}=${iN}&iT${index}=${iT}&iC${index}=${iC}`;
      });

      const timerURL = `${window.location.origin}${window.location.pathname}?timerName=${timerName}&nR=${nR}&cT=${cT}${intervalParams}`;
      history.pushState({}, null, timerURL);
    }


    window.addEventListener('load', loadTimerFromURL);

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => {
          console.log('Service worker registered.', reg);
        }).catch(err => {
          console.log('Service worker registration failed:', err);
        });
      });
    }

    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (event) => {
      // Prevent Chrome 67 and earlier from automatically showing the prompt
      event.preventDefault();
      // Save the event for later use
      deferredPrompt = event;
      // Show the install button
      document.getElementById('installButton').style.display = 'block';
    });

    document.getElementById('installButton').addEventListener('click', (event) => {
      // Hide the install button
      document.getElementById('installButton').style.display = 'none';
      // Show the prompt
      deferredPrompt.prompt();
      // Wait for the user to respond to the prompt
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        } else {
          console.log('User dismissed the install prompt');
        }
        deferredPrompt = null;
      });
    });



    let currentIntervalIndex = 0;
    let currentRound = 0;
    let totalRounds = 0;
    let timer;
    let remainingTime = 0;
    let countdownRemaining = 0;


    function addInterval() {
      const newInterval = document.createElement('div');
      newInterval.classList.add('interval');
      newInterval.innerHTML = `
        <input type="text" placeholder="Interval Name" class="interval-name">
        <input type="number" placeholder="Interval (seconds)" class="interval-time">
        <input type="color" class="interval-color" value="#FFFFFF">
    `;
      document.getElementById('intervals').appendChild(newInterval);
    }

    function startTimer() {
      const intervals = document.querySelectorAll('.interval-time');
      const rounds = document.getElementById('numRounds').value;

      if (intervals.length === 0 || !rounds) {
        alert('Please set intervals and rounds.');
        return;
      }

      totalRounds = rounds;

      if (timer) clearInterval(timer);

      // Start with countdown
      countdownRemaining = (document.getElementById('countdownTime').value || 5) * 1000;
      updateCountdownDisplay();

      timer = setInterval(() => {
        if (countdownRemaining > 0) {
          countdownRemaining -= 10;
          updateCountdownDisplay();
          if (countdownRemaining <= 0) {
            // Countdown ended, start the interval timer
            setNextIntervalTime();
            updateDisplay();
          }
        } else {
          // Interval timer logic
          remainingTime -= 10;
          updateDisplay();

          if (remainingTime <= 0) {
            currentIntervalIndex++;
            if (currentIntervalIndex >= intervals.length) {
              currentIntervalIndex = 0;
              currentRound++;
              if (currentRound >= totalRounds) {
                stopTimer();
                return;
              }
            }
            setNextIntervalTime();
          }
        }
      }, 10);
    }

    function updateCountdownDisplay() {
      const seconds = Math.floor(countdownRemaining / 1000);
      const milliseconds = countdownRemaining % 1000;

      document.getElementById('currentInterval').textContent = `Starting in ${seconds}.${milliseconds} seconds`;
    }


    function setNextIntervalTime() {
      const intervals = document.querySelectorAll('.interval-time');
      remainingTime = intervals[currentIntervalIndex].value * 1000;
    }

    function updateDisplay() {
      const intervalNames = document.querySelectorAll('.interval-name');
      const intervalColors = document.querySelectorAll('.interval-color');

      const currentIntervalName = intervalNames[currentIntervalIndex].value || `Interval ${currentIntervalIndex + 1}`;
      const currentIntervalColor = intervalColors[currentIntervalIndex].value || "#FFFFFF"; // default to white if no color is set

      document.body.style.backgroundColor = currentIntervalColor; // set background color

      const seconds = Math.floor(remainingTime / 1000);
      const milliseconds = remainingTime % 1000;

      document.getElementById('currentInterval').textContent = `${currentIntervalName}: ${seconds}.${milliseconds} seconds remaining. Round: ${currentRound + 1}/${totalRounds}`;
    }

    function stopTimer() {
      clearInterval(timer);
      currentIntervalIndex = 0;
      currentRound = 0;
      remainingTime = 0;
      countdownRemaining = 0;
      document.getElementById('currentInterval').textContent = '';
      document.body.style.backgroundColor = "#FFFFFF"; // Reset background color to white (or any default color you prefer)
    }

  </script>
</body>

</html>